name: WHM Visa Check (Spain ‚Üí Australia)

on:
  schedule:
    - cron: "*/5 * * * *"   # cada 5 minutos (UTC)
  workflow_dispatch:        # permite lanzarlo manualmente desde "Actions"

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependencias
        run: pip install requests beautifulsoup4

      - name: Comprobar estado WHM (Espa√±a)
        id: check
        env:
          URL: "https://immi.homeaffairs.gov.au/what-we-do/whm-program/status-of-country-caps"
          COUNTRY: "Spain"
        run: |
          python - <<'PY'
          import os, sys, re, unicodedata, requests
          from bs4 import BeautifulSoup

          URL = os.getenv("URL")
          COUNTRY = os.getenv("COUNTRY", "Spain").lower()

          # Descarga
          r = requests.get(URL, timeout=20, headers={"User-Agent": "WHM-check/1.0"})
          r.raise_for_status()

          # Parse
          s = BeautifulSoup(r.text, "html.parser")
          cell = s.find(["td","th"], string=lambda t: t and COUNTRY in t.lower())
          if not cell:
              print("::error::No se encontr√≥ el pa√≠s en la tabla"); sys.exit(1)

          # La celda de estado es la siguiente <td> en la fila
          state_cell = cell.find_next("td")
          if not state_cell:
              print("::error::No se encontr√≥ la celda de estado"); sys.exit(1)

          raw = state_cell.get_text(separator=" ", strip=True)

          # Normalizaci√≥n robusta
          norm = unicodedata.normalize("NFKC", raw).lower().replace("\xa0", " ")
          norm = norm.replace("*", " ")      # quita asteriscos
          norm = re.sub(r"[‚Äì‚Äî\-¬∑‚Ä¢:;()\[\]]", " ", norm)  # quita puntuaci√≥n com√∫n
          norm = re.sub(r"\s+", " ", norm).strip()       # colapsa espacios

          # Clasificaci√≥n por palabras clave (tolerante)
          if "open" in norm:
              status = "open"
          elif "closed" in norm:
              status = "closed"
          elif "pause" in norm:  # cubre paused/pause
              status = "paused"
          else:
              status = norm  # deja rastro si aparece algo nuevo

          print(f"Estado detectado: {status} (raw='{raw}')")

          # Exportar a outputs del job
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"status={status}\n")
          PY

      - name: Enviar alerta por Telegram (si est√° OPEN ‚Üí spamea cada 5 min)
        if: steps.check.outputs.status == 'open'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          URL: "https://immi.homeaffairs.gov.au/what-we-do/whm-program/status-of-country-caps"
          COUNTRY_TITLE: "Spain"
        run: |
          python - <<'PY'
          import os, requests
          token = os.environ["TELEGRAM_BOT_TOKEN"]
          chat_id = os.environ["TELEGRAM_CHAT_ID"]
          url = f"https://api.telegram.org/bot{token}/sendMessage"
          msg = f"üö® ¬°{os.environ['COUNTRY_TITLE']} est√° OPEN! Revisa y aplica: {os.environ['URL']}"
          r = requests.post(url, data={"chat_id": chat_id, "text": msg}, timeout=20)
          print("Telegram status:", r.status_code, r.text[:200])
          PY
